#!/usr/bin/env python3.1
# -*- coding: UTF-8 -*-

import os
import cgi
import codecs
import sys
import url
import time

IS_LOCAL = False
ROOTDIR = "/home/sunus/apache/" if IS_LOCAL == True else "/usr/local/apache2/"
HOSTNAME = "http://localhost/"  if IS_LOCAL == True else "http://184.164.137.154/"
def gate_open(page):
        print("Content-type:text/html; charset=UTF-8\r\n\r\n")
        print('<html>\
                        <head>\
                        <meta content="text/html; charset=UTF-8"\
                        http-equiv="content-type">\
                        <title>门开了</title>\
                        </head>\
                        <body>\
                        <a href="{0}">点我开门</a><br>\
                        <br>\
                        </body>\
                        </html>'.format(page))

def gate_close():
        print("Content-type:text/html; charset=UTF-8\r\n\r\n")
        print('<html>\
                        <head>\
                        <meta content="text/html; charset=UTF-8"\
                        http-equiv="content-type">\
                        <title>芝麻不开门：（</title>\
                        </head>\
                        <body>\
                        您也许输入了错误的传送门／实验门的密码<br>\
                        P.S 传送门和实验门一次只能打开一个噢，另一扇门请留空（不输入）<br>\
                        </body>\
                        </html>')

def transport(transport_code):
        short_url = "http://goo.gl/" + transport_code
        long_url = url.get_longurl(short_url)
        page = long_url.rpartition('/')[2]
        gate_open(HOSTNAME + "/history/{0}".format(page))

def experiment(experiment_code):
        token = str(int(time.time()))
        if os.system("cp {0}htdocs/index.html {0}htdocs/experiment/{1}.html".format(ROOTDIR, token)) == 0:
                gate_open("{0}experiment/{1}.html".format(HOSTNAME, token))
        else:
                gate_close()

def main():
        sys.stdout = codecs.getwriter('utf8')(sys.stdout.buffer) # comment this out if you want to debug
        form = cgi.FieldStorage()
        transport_code = form.getvalue("transport_code", "0")
        experiment_code = form.getvalue("experiment_code", "0")
        if (transport_code != "0" and experiment_code != "0") or (transport_code == "0" and experiment_code == "0"):
                gate_close()
        elif transport_code != "0":
                transport(transport_code)
        else:
                experiment(experiment_code)
                

if __name__ == "__main__":
        main()
